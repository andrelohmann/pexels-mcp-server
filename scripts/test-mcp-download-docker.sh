#!/usr/bin/env bash
set -euo pipefail

HOST_WORKSPACE="${HOST_WORKSPACE:-$(pwd -P)}"

docker run --rm -i --user 0:0 \
  -v "${HOST_WORKSPACE}:/workspace" \
  -w /opt/mcp \
  -e PEXELS_API_KEY="${PEXELS_API_KEY:-}" \
  -e PEXELS_TEST_QUERY="${PEXELS_TEST_QUERY:-}" \
  -e PEXELS_TEST_DOWNLOAD_PATH="${PEXELS_TEST_DOWNLOAD_PATH:-}" \
  -e PEXELS_TEST_SIZE="${PEXELS_TEST_SIZE:-}" \
  mcp-pexels:local \
  node --input-type=module -e 'import { Client } from "@modelcontextprotocol/sdk/client/index.js"; import { StdioClientTransport } from "@modelcontextprotocol/sdk/client/stdio.js"; import fs from "node:fs"; import path from "node:path"; const query = process.env.PEXELS_TEST_QUERY || "mountains"; const downloadPath = process.env.PEXELS_TEST_DOWNLOAD_PATH || "tmp"; const size = process.env.PEXELS_TEST_SIZE || "original"; if (path.isAbsolute(downloadPath)) { console.error("download-path must be a relative path within the current workspace"); process.exit(1); } const baseDir = "/workspace"; process.chdir(baseDir); const targetDir = path.resolve(baseDir, downloadPath); const baseReal = fs.realpathSync(baseDir); if (targetDir !== baseReal && !targetDir.startsWith(`${baseReal}${path.sep}`)) { console.error("download-path resolves outside the current workspace"); process.exit(1); } const client = new Client({ name: "mcp-test", version: "1.0.0" }); const transport = new StdioClientTransport({ command: "node", args: ["/opt/mcp/build/index.js"], cwd: "/workspace", env: { ...process.env, PEXELS_API_KEY: process.env.PEXELS_API_KEY } }); await client.connect(transport); const search = await client.callTool({ name: "searchPhotos", arguments: { query, perPage: 1 } }); let photoId; for (const content of search.content ?? []) { if (content.type === "text") { try { const data = JSON.parse(content.text); if (Array.isArray(data.photos) && data.photos[0]?.id) { photoId = data.photos[0].id; break; } } catch {} } } if (!photoId) { console.error("Could not find a photo ID from search response."); process.exit(1); } const download = await client.callTool({ name: "downloadPhoto", arguments: { id: Number(photoId), size } }); let downloadUrl; let suggestedFilename; for (const content of download.content ?? []) { if (content.type === "text") { if (!downloadUrl && content.text.includes("Download Link")) { let part = content.text.split("Download Link")[1] || ""; const colonIndex = part.indexOf(":"); if (colonIndex !== -1) { part = part.slice(colonIndex + 1); } if (part.includes("\n")) part = part.split("\n")[0]; if (part.includes("Attribution:")) part = part.split("Attribution:")[0]; downloadUrl = part.trim(); } if (!suggestedFilename && content.text.includes("Suggested Filename:")) { let part = content.text.split("Suggested Filename:")[1] || ""; if (part.includes("\n")) part = part.split("\n")[0]; if (part.includes("Attribution:")) part = part.split("Attribution:")[0]; suggestedFilename = part.trim(); } } } if (!downloadUrl) { console.error("Could not extract download URL."); process.exit(1); } if (!suggestedFilename) { const urlPath = new URL(downloadUrl).pathname; suggestedFilename = path.basename(urlPath) || `pexels_${photoId}_${size}.jpg`; } if (!fs.existsSync(targetDir)) { fs.mkdirSync(targetDir, { recursive: true }); } const targetReal = fs.realpathSync(targetDir); if (targetReal !== baseReal && !targetReal.startsWith(`${baseReal}${path.sep}`)) { console.error("download-path resolves outside the current workspace"); process.exit(1); } const filePath = path.join(targetDir, suggestedFilename); const response = await fetch(downloadUrl); if (!response.ok) { console.error(`Failed to download: ${response.status} ${response.statusText}`); process.exit(1); } const buffer = Buffer.from(await response.arrayBuffer()); fs.writeFileSync(filePath, buffer); console.log(`Downloaded ${path.basename(filePath)}`); await transport.close();'
